#!/bin/bash
# vim: ts=4:sw=4

. ~/plescripts/plelib.sh
. ~/plescripts/global.cfg
EXEC_CMD_ACTION=EXEC

typeset -r ME=$0
typeset -r str_usage=\
"Usage : $ME <str>
	[-server=<str>]	si non définie testera ID_DB (cf set_db)
	[-wait_os=yes]  par défaut attend que l'OS de la VM ait démarré pour lancer la VM suivante.
"

script_banner $ME $@

typeset server=undef
typeset	wait_os=yes

while [ $# -ne 0 ]
do
	case $1 in
		-emul)
			EXEC_CMD_ACTION=NOP
			first_args=-emul
			shift
			;;

		-server=*)
			server=${1##*=}
			shift
			;;

		-wait_os=*)
			wait_os=${1##*=}
			shift
			;;

		-h|-help|help)
			info "$str_usage"
			LN
			exit 1
			;;

		*)
			if [ $server == undef ]
			then
				server=$1
				shift
			else
				error "Arg '$1' invalid."
				LN
				info "$str_usage"
				exit 1
			fi
			;;
	esac
done

[[ $server == undef && -v ID_DB ]] && server=$ID_DB
exit_if_param_undef server	"$str_usage"

exit_if_param_invalid wait_os "yes no" "$str_usage"

#	============================================================================
#	Mémorise le nom des VMs correspondant au pattern $server
typeset -a vm_list
while read vm_name
do
	[ x"$vm_name" != x ] && vm_list+=( $vm_name )
done<<<"$(VBoxManage list vms | grep "$server" | cut -d\" -f2)"

info "${#vm_list[@]} server(s) found for pattern $server : ${vm_list[*]}"
LN
[ ${#vm_list[@]} -eq 0 ] && exit 1

#	============================================================================
#	Démarre les VMs :
typeset -i nr_vm_started=0
typeset	-a vm_started_list

for vm in ${vm_list[*]}
do

	if [[ "$vm" == "$infra_hostname" && "$INSTALLING_INFRA" != yes ]]
	then
		exec_cmd -c "~/plescripts/virtualbox/start_vm_infra"
		[ $? -eq 0 ] && nr_vm_started=nr_vm_started+1
	else
		exec_cmd -c "VBoxManage startvm $vm --type headless"
		if [ $? -eq 0 ]
		then
			nr_vm_started=nr_vm_started+1
			vm_started_list+=( $vm )
		else
			error "Failed to start $vm" 
		fi
		LN
	fi

done

#	============================================================================
if [ $wait_os == yes ]
then
	line_separator
	for vm in ${vm_started_list[*]}
	do
		exec_cmd wait_server $vm
		LN
	done
fi

#	============================================================================
if [ $nr_vm_started -eq ${#vm_list[@]} ]
then
	exit 0	# Toutes les VMs ont démarrés.
else
	exit 1	# Au moins une VM n'a pas démarré.
fi
